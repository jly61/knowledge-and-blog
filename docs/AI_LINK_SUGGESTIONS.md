# AI 双向链接建议功能

## 📋 功能概述

AI 双向链接建议功能可以在编辑笔记时，智能推荐可以链接的相关笔记，帮助用户快速建立笔记之间的关联，增强知识网络。

## ✅ 已完成功能

### 1. 链接建议 Server Action
- ✅ 创建 `app/actions/ai/links.ts`
- ✅ 基于向量相似度检索相关笔记
- ✅ 自动过滤已存在的链接和当前笔记
- ✅ 支持根据文本片段推荐链接

### 2. 链接建议组件
- ✅ 创建 `components/editor/ai-link-suggestions.tsx`
- ✅ 实时检测文本变化
- ✅ 输入 `[[` 时自动触发建议
- ✅ 显示建议列表（标题、摘要、相似度）
- ✅ 键盘导航支持（↑↓ 键选择，Enter 键插入）
- ✅ 防抖优化，避免频繁请求

### 3. 编辑器集成
- ✅ 在 `components/editor/markdown-split-editor.tsx` 中集成
- ✅ 跟踪光标位置
- ✅ 一键插入链接功能
- ✅ 智能处理 `[[` 输入场景

### 4. 笔记编辑器集成
- ✅ 在 `components/notes/note-editor.tsx` 中启用
- ✅ 传递当前笔记 ID，避免自链接

## 🎯 使用方法

### 方法 1：输入 `[[` 触发建议（推荐）

1. 在编辑器中输入 `[[`
2. 系统自动检测并显示链接建议弹窗
3. 使用 ↑↓ 键选择建议，或点击建议项
4. 按 Enter 键或点击建议项插入链接
5. 链接会自动插入为 `[[笔记标题]]` 格式

### 方法 2：手动触发建议

1. 在编辑器中输入内容（至少 50 个字符）
2. 点击编辑器右上角的"AI 链接建议"按钮（带 ✨ 图标）
3. 等待建议加载完成
4. 从建议列表中选择要链接的笔记
5. 点击建议项插入链接

### 方法 3：自动建议（后台运行）

1. 在编辑器中输入内容
2. 系统会在后台分析内容（800ms 防抖）
3. 如果找到相关笔记，会在右上角显示建议数量
4. 点击按钮查看建议列表

## 🔧 技术实现

### Server Action

```typescript
// app/actions/ai/links.ts
export async function suggestLinks(
  content: string,
  currentNoteId?: string,
  limit: number = 5
): Promise<LinkSuggestion[]>
```

**功能**：
- 接收当前编辑的内容
- 使用 RAG 检索相关笔记（基于向量相似度）
- 过滤已存在的链接和当前笔记
- 返回推荐的笔记列表（包含相似度分数）

### 推荐算法

1. **向量相似度搜索**：
   - 使用 RAG 的 `retrieveRelevantNotes` 函数
   - 基于余弦相似度（阈值 0.6）
   - 分析光标附近的文本上下文（前后各 100 个字符）

2. **智能过滤**：
   - 排除当前笔记（避免自链接）
   - 排除已存在的链接（避免重复）
   - 排除当前笔记标题（避免自链接）

3. **推荐数量**：
   - 默认推荐 5 个相关笔记
   - 按相似度排序
   - 显示相似度百分比

### 用户体验优化

1. **防抖机制**：
   - 800ms 防抖，避免频繁请求
   - 输入 `[[` 时立即触发，无需等待

2. **键盘导航**：
   - ↑↓ 键：选择建议
   - Enter 键：插入选中的链接
   - Esc 键：关闭建议弹窗

3. **智能插入**：
   - 如果光标前有 `[[`，只插入笔记标题和 `]]`
   - 否则，插入完整的 `[[笔记标题]]` 格式
   - 插入后自动设置光标位置

## 📝 代码文件清单

### 新增文件
- `app/actions/ai/links.ts` - 链接建议 Server Action
- `components/editor/ai-link-suggestions.tsx` - 链接建议组件
- `docs/AI_LINK_SUGGESTIONS.md` - 功能文档（本文档）

### 修改文件
- `components/editor/markdown-split-editor.tsx` - 集成链接建议功能
- `components/notes/note-editor.tsx` - 启用链接建议

## 🎨 UI 设计

### 建议弹窗

- **位置**：编辑器右上角
- **触发**：输入 `[[` 或点击按钮
- **内容**：
  - 建议列表（最多 5 个）
  - 每个建议显示：标题、摘要、相似度
  - 键盘导航提示

### 建议项

- **布局**：标题 + 摘要 + 相似度
- **交互**：
  - 鼠标悬停：高亮选中
  - 点击：插入链接
  - 键盘导航：↑↓ 键选择

## 🐛 已知问题和限制

1. **内容长度要求**：需要至少 50 个字符才会自动触发建议（避免对短文本进行不必要的分析）
2. **向量依赖**：需要笔记已生成向量嵌入，否则无法推荐
3. **相似度阈值**：设置为 0.6，可能过滤掉一些相关但相似度较低的笔记
4. **防抖延迟**：800ms 防抖可能导致建议显示略有延迟

## 🔮 未来改进

- [ ] 支持实时建议（输入时即时显示）
- [ ] 显示推荐理由（为什么推荐这个笔记）
- [ ] 支持创建新笔记（如果推荐的笔记不存在）
- [ ] 支持批量插入多个链接
- [ ] 添加建议历史记录
- [ ] 支持自定义相似度阈值

## 💡 使用技巧

1. **快速链接**：输入 `[[` 后立即显示建议，无需等待
2. **键盘操作**：使用键盘导航比鼠标更快
3. **相似度参考**：相似度越高，笔记越相关
4. **上下文分析**：系统会分析光标附近的文本，确保建议与当前编辑内容相关

---

**最后更新**：2024-12-05

