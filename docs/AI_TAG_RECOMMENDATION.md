# AI 自动标签推荐功能

## 📋 功能概述

AI 自动标签推荐功能可以根据文章/笔记的内容，智能推荐合适的标签和分类，帮助用户快速组织和管理内容。

## ✅ 已完成功能

### 1. 标签推荐 Server Action
- ✅ 创建 `app/actions/ai/tags.ts`
- ✅ 支持 OpenAI 和 Ollama 本地模型
- ✅ 智能解析 AI 返回结果（支持 JSON 和 Markdown 格式）
- ✅ 从现有标签和分类列表中选择推荐
- ✅ 支持推荐理由（可选）

### 2. 笔记编辑器集成
- ✅ 在 `components/notes/note-editor.tsx` 中添加 AI 推荐按钮
- ✅ 点击按钮自动推荐标签和分类
- ✅ 推荐结果自动合并到已选择的标签中
- ✅ 加载状态和错误提示

### 3. 文章编辑器集成
- ✅ 在 `components/posts/post-editor.tsx` 中添加 AI 推荐按钮
- ✅ 支持推荐标签和分类
- ✅ 推荐结果自动合并

### 4. 发布表单集成
- ✅ 在 `components/posts/publish-note-client.tsx` 中添加 AI 推荐按钮
- ✅ 发布文章时可以使用标签推荐

### 5. Prompt 模板
- ✅ 创建标签推荐提示词模板（`lib/ai/prompts.ts`）
- ✅ 包含详细的推荐要求和格式说明

## 🎯 使用方法

### 在编辑笔记时使用

1. 打开笔记编辑页面（新建或编辑）
2. 填写笔记标题和内容
3. 在"标签"字段右上角，点击"AI 推荐"按钮（带 ✨ 图标）
4. 等待 AI 推荐完成（通常需要 3-10 秒）
5. 推荐的标签会自动添加到已选择的标签中
6. 如果推荐了分类且当前没有分类，会自动设置分类
7. 可以手动取消不需要的推荐标签
8. 点击"保存"完成编辑

### 在编辑文章时使用

1. 打开文章编辑页面：`/posts/[slug]/edit`
2. 填写文章标题和内容
3. 在"分类和标签"卡片中，找到"标签"字段
4. 点击右上角的"AI 推荐"按钮
5. 等待推荐完成
6. 推荐的标签和分类会自动应用
7. 可以手动调整推荐结果
8. 点击"保存"完成更新

### 在发布文章时使用

1. 打开笔记详情页，点击"发布为文章"
2. 在发布表单的"分类和标签"卡片中
3. 点击"标签"字段右上角的"AI 推荐"按钮
4. 等待推荐完成
5. 推荐的标签和分类会自动应用
6. 点击"发布文章"完成发布

## 🔧 技术实现

### Server Action

```typescript
// app/actions/ai/tags.ts
export async function recommendTags(
  title: string,
  content: string,
  existingTagIds: string[] = []
): Promise<TagRecommendationResult>
```

**功能**：
- 接收文章/笔记标题和内容
- 获取所有可用标签和分类列表
- 调用 AI 模型生成推荐
- 解析返回结果（支持 JSON 和 Markdown 格式）
- 返回推荐的标签 ID 列表和分类 ID

### AI 模型支持

- **OpenAI**：优先使用（如果配置了 `OPENAI_API_KEY`）
  - 使用 `gpt-3.5-turbo` 或 `gpt-4o-mini`
  - 通过 `generateText` API 调用
  
- **Ollama**：本地模型（如果没有配置 OpenAI）
  - 使用推荐的模型（如 `llama3.1:8b`）
  - 通过 HTTP API 调用

### 推荐逻辑

1. **标签推荐**：
   - 从所有可用标签中选择 3-5 个最相关的标签
   - 避免推荐已选择的标签（除非确实非常相关）
   - 推荐结果会合并到已选择的标签中（不覆盖）

2. **分类推荐**：
   - 推荐 1 个最合适的分类
   - 只在当前没有分类时自动应用
   - 如果已有分类，不会覆盖

### 结果解析

AI 返回的结果可能有两种格式：

1. **JSON 格式**（推荐）：
```json
{
  "tags": ["标签1", "标签2", "标签3"],
  "category": "分类名称",
  "reasons": {
    "标签1": "推荐理由1",
    "标签2": "推荐理由2"
  }
}
```

2. **Markdown 格式**（备用）：
```markdown
## 推荐标签
- 标签1：推荐理由1
- 标签2：推荐理由2

## 推荐分类
- 分类名称：推荐理由
```

系统会自动识别并解析这两种格式，然后匹配到实际的标签和分类 ID。

## 📝 代码文件清单

### 新增文件
- `app/actions/ai/tags.ts` - 标签推荐 Server Action
- `docs/AI_TAG_RECOMMENDATION.md` - 功能文档（本文档）

### 修改文件
- `lib/ai/prompts.ts` - 添加标签推荐提示词模板
- `components/notes/note-editor.tsx` - 添加 AI 推荐按钮
- `components/posts/post-editor.tsx` - 添加 AI 推荐按钮
- `components/posts/publish-note-client.tsx` - 添加 AI 推荐按钮

## 🎨 UI 设计

### AI 推荐按钮

- **位置**：标签字段的右上角
- **图标**：✨ Sparkles 图标
- **状态**：
  - 正常：显示"AI 推荐"文字和图标
  - 加载中：显示"推荐中..."和 Spinner
  - 禁用：在表单提交时或标题/内容为空时禁用

### 用户体验

1. **即时反馈**：点击按钮后立即显示加载状态
2. **自动应用**：推荐完成后自动添加到已选择的标签中
3. **可调整**：推荐的结果可以手动取消或添加
4. **错误提示**：如果推荐失败，显示友好的错误提示
5. **智能合并**：推荐结果不会覆盖已选择的标签，而是合并

## 🐛 已知问题和限制

1. **标签匹配**：标签名称必须完全匹配（区分大小写），如果 AI 返回的标签名称与现有标签不完全一致，可能无法匹配
2. **推荐数量**：最多推荐 5 个标签，如果内容与多个标签相关，可能不会全部推荐
3. **分类推荐**：只在当前没有分类时自动应用，避免覆盖用户的选择
4. **生成时间**：根据模型和内容长度，推荐可能需要 3-10 秒

## 🔮 未来改进

- [ ] 显示推荐理由（如果 AI 返回了推荐理由）
- [ ] 支持创建新标签（如果推荐的标签不存在）
- [ ] 支持批量推荐多篇文章的标签
- [ ] 添加推荐准确度评分
- [ ] 支持自定义推荐规则
- [ ] 缓存推荐结果，避免重复推荐

---

**最后更新**：2024-12-05

