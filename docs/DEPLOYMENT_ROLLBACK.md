# 部署回滚指南

## 📋 概述

当生产环境出现问题时，需要快速回滚到之前的稳定版本。本文档说明如何安全地回滚部署。

## 🔄 回滚方式

### 方式 1：Vercel 自动回滚（推荐）

Vercel 提供了简单的回滚功能：

#### 步骤

1. **访问 Vercel 项目页面**
   - 登录 [Vercel Dashboard](https://vercel.com/dashboard)
   - 选择你的项目

2. **查看部署历史**
   - 点击 "Deployments" 标签
   - 查看所有部署记录

3. **选择要回滚的版本**
   - 找到稳定版本的部署
   - 点击部署右侧的 "..." 菜单

4. **执行回滚**
   - 选择 "Promote to Production"
   - 确认回滚操作

#### 优点
- ✅ 操作简单，一键回滚
- ✅ 自动处理域名和配置
- ✅ 保留部署历史

---

### 方式 2：Git 回滚 + 重新部署

如果需要回滚代码并重新部署：

#### 步骤

1. **查找稳定版本的 Commit**
   ```bash
   git log --oneline
   ```

2. **回滚到指定版本**
   ```bash
   # 方式 1：创建回滚提交
   git revert <commit-hash>
   git push origin main
   
   # 方式 2：重置到指定版本（谨慎使用）
   git reset --hard <commit-hash>
   git push origin main --force
   ```

3. **Vercel 自动重新部署**
   - Vercel 检测到代码变更后会自动部署

---

### 方式 3：数据库迁移回滚

如果回滚涉及数据库结构变更：

#### 步骤

1. **查看迁移历史**
   ```bash
   pnpm prisma migrate status
   ```

2. **回滚迁移**
   ```bash
   # 回滚到上一个迁移
   pnpm prisma migrate resolve --rolled-back <migration-name>
   
   # 或手动回滚
   # 1. 查看迁移文件
   # 2. 手动执行反向 SQL
   ```

3. **重新应用迁移**
   ```bash
   pnpm prisma migrate deploy
   ```

**注意**：数据库回滚需要谨慎，建议先备份数据。

---

## 🛡️ 回滚前检查清单

在执行回滚前，确认以下事项：

- [ ] **问题确认**：确认确实需要回滚
- [ ] **备份数据**：备份当前数据库（如果涉及数据变更）
- [ ] **记录问题**：记录导致回滚的问题
- [ ] **通知团队**：通知团队成员回滚操作
- [ ] **选择版本**：确认要回滚到的稳定版本

---

## 📝 回滚脚本

创建自动化回滚脚本（可选）：

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

echo "🔄 开始回滚部署..."

# 1. 获取要回滚的版本
VERSION=${1:-"previous"}
echo "回滚到版本: $VERSION"

# 2. 使用 Vercel CLI 回滚
if command -v vercel &> /dev/null; then
  vercel rollback $VERSION
else
  echo "❌ 未安装 Vercel CLI"
  echo "请访问 Vercel Dashboard 手动回滚"
  exit 1
fi

echo "✅ 回滚完成"
```

使用方法：
```bash
chmod +x scripts/rollback.sh
./scripts/rollback.sh previous  # 回滚到上一个版本
```

---

## 🔍 回滚后验证

回滚后，验证以下内容：

- [ ] **功能验证**：测试核心功能是否正常
- [ ] **数据完整性**：检查数据是否完整
- [ ] **性能检查**：确认性能正常
- [ ] **错误监控**：检查错误日志
- [ ] **用户反馈**：收集用户反馈

---

## 🚨 紧急回滚流程

### 严重问题（影响所有用户）

1. **立即回滚**
   - 使用 Vercel Dashboard 快速回滚
   - 或使用 `vercel rollback` 命令

2. **通知团队**
   - 在团队群组中通知
   - 说明回滚原因

3. **问题修复**
   - 在开发环境复现问题
   - 修复后重新测试
   - 重新部署

### 部分问题（影响部分功能）

1. **评估影响**
   - 评估问题影响范围
   - 决定是否需要回滚

2. **快速修复**
   - 如果可能，优先尝试快速修复
   - 修复后立即部署

3. **回滚决策**
   - 如果无法快速修复，执行回滚

---

## 📊 回滚记录

建议记录每次回滚：

| 日期 | 回滚版本 | 原因 | 负责人 | 状态 |
|------|---------|------|--------|------|
| 2024-01-01 | v1.2.3 | 数据库连接错误 | 张三 | 已解决 |

---

## 🔄 预防措施

减少回滚需求的最佳实践：

1. **充分测试**
   - 本地测试
   - 预览环境测试
   - 自动化测试

2. **渐进式部署**
   - 使用预览部署测试
   - 小步迭代
   - 监控错误

3. **数据库迁移**
   - 向后兼容的迁移
   - 分阶段迁移
   - 保留回滚方案

4. **监控告警**
   - 设置错误监控
   - 性能监控
   - 及时告警

---

## 📚 相关文档

- [部署指南](./DEPLOYMENT_GUIDE.md)
- [环境变量配置](./DEPLOYMENT_ENV.md)
- [Vercel 文档](https://vercel.com/docs)

---

## 💡 最佳实践

1. **保留部署历史**：不要删除旧的部署记录
2. **标记稳定版本**：在 Git 中标记稳定版本
3. **文档化变更**：记录每次部署的变更内容
4. **定期演练**：定期进行回滚演练
5. **自动化测试**：部署前运行自动化测试

