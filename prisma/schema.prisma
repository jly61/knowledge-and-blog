// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户和认证 ====================

/// 用户模型 - 存储系统用户信息
model User {
  /// 用户唯一标识符（UUID）
  id            String    @id @default(uuid())
  /// 用户邮箱地址，唯一
  email         String    @unique
  /// 用户显示名称
  name          String?
  /// 用户头像图片 URL
  image         String?
  /// 邮箱验证时间
  emailVerified DateTime?
  /// 创建时间
  createdAt     DateTime  @default(now())
  /// 更新时间
  updatedAt     DateTime  @updatedAt

  /// OAuth 账号关联
  accounts      Account[]
  /// 用户会话
  sessions      Session[]
  /// 用户创建的笔记
  notes         Note[]
  /// 用户发布的文章
  posts         Post[]
  /// 用户发表的评论
  comments      Comment[]
  /// 用户的每日笔记
  dailyNotes    DailyNote[]
}

/// OAuth 账号模型 - 存储第三方登录账号信息（GitHub、Google 等）
model Account {
  /// 账号唯一标识符（UUID）
  id                String  @id @default(uuid())
  /// 关联的用户 ID
  userId            String
  /// 账号类型（如 oauth、credentials）
  type              String
  /// OAuth 提供商名称（如 github、google）
  provider          String
  /// 提供商返回的账号 ID
  providerAccountId String
  /// OAuth 刷新令牌
  refresh_token     String? @db.Text
  /// OAuth 访问令牌
  access_token      String? @db.Text
  /// 令牌过期时间（Unix 时间戳）
  expires_at        Int?
  /// 令牌类型（如 Bearer）
  token_type        String?
  /// OAuth 授权范围
  scope             String?
  /// OpenID Connect ID 令牌
  id_token          String? @db.Text
  /// OAuth 会话状态
  session_state     String?

  /// 关联的用户
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// 会话模型 - 存储用户登录会话信息
model Session {
  /// 会话唯一标识符（UUID）
  id           String   @id @default(uuid())
  /// 会话令牌，用于验证用户身份
  sessionToken String   @unique
  /// 关联的用户 ID
  userId       String
  /// 会话过期时间
  expires      DateTime
  /// 关联的用户
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// 验证令牌模型 - 用于邮箱验证等场景
model VerificationToken {
  /// 验证标识符（通常是邮箱地址）
  identifier String
  /// 验证令牌，唯一
  token      String   @unique
  /// 令牌过期时间
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== 笔记系统 ====================

/// 笔记模型 - 用户的知识笔记，支持 Markdown 格式
model Note {
  /// 笔记唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 笔记标题
  title       String
  /// 笔记内容（Markdown 格式）
  content     String   @db.Text
  /// 笔记摘要，用于列表展示
  excerpt     String?  @db.Text
  /// 是否为私有笔记（默认私有）
  isPrivate   Boolean  @default(true)
  /// 是否置顶
  isPinned    Boolean  @default(false)
  /// 是否收藏
  isFavorite  Boolean  @default(false)
  /// 是否为目录页（Map of Contents）
  isMOC       Boolean  @default(false)

  /// 创建者用户 ID
  userId      String
  /// 关联的用户
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 所属分类 ID
  categoryId  String?
  /// 关联的分类
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  /// 关联的标签
  tags        Tag[]
  /// 从当前笔记指向其他笔记的链接
  links       NoteLink[] @relation("FromNote")
  /// 指向当前笔记的反向链接
  backlinks   NoteLink[] @relation("ToNote")

  /// 关联的文章 ID（如果笔记已发布为文章）
  postId      String?  @unique
  /// 关联的文章
  post        Post?    @relation("NotePost")

  /// 所属的每日笔记 ID
  dailyNoteId String?
  /// 关联的每日笔记
  dailyNote   DailyNote? @relation(fields: [dailyNoteId], references: [id], onDelete: SetNull)

  /// 笔记版本历史
  versions    NoteVersion[]

  /// 向量嵌入（用于 RAG 检索，1536 维，OpenAI text-embedding-3-small）
  /// 注意：需要在数据库中启用 pgvector 扩展
  embedding   Unsupported("vector(1536)")?

  /// 创建时间
  createdAt   DateTime @default(now())
  /// 更新时间
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([categoryId])
  @@index([isPinned, updatedAt])
  // 注意：PostgreSQL 全文搜索可以通过原生 SQL 实现，Prisma 的 @@fulltext 支持有限
  // 如需全文搜索，可以在应用层使用 PostgreSQL 的 to_tsvector 和 to_tsquery
  // 注意：向量索引需要在数据库迁移中手动创建：CREATE INDEX ON "Note" USING ivfflat (embedding vector_cosine_ops);
}

/// 笔记链接模型 - 记录笔记之间的双向链接关系
model NoteLink {
  /// 链接唯一标识符（UUID）
  id          String   @id @default(uuid())

  /// 源笔记 ID（链接的起点）
  fromNoteId  String
  /// 源笔记
  fromNote    Note     @relation("FromNote", fields: [fromNoteId], references: [id], onDelete: Cascade)

  /// 目标笔记 ID（链接的终点）
  toNoteId    String
  /// 目标笔记
  toNote      Note     @relation("ToNote", fields: [toNoteId], references: [id], onDelete: Cascade)

  /// 链接出现的上下文内容
  context     String?  @db.Text
  /// 链接在内容中的位置（字符位置）
  position    Int?

  /// 创建时间
  createdAt   DateTime @default(now())

  @@unique([fromNoteId, toNoteId])
  @@index([fromNoteId])
  @@index([toNoteId])
}

/// 笔记版本模型 - 记录笔记的历史版本
model NoteVersion {
  /// 版本唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 版本保存时的标题
  title       String
  /// 版本保存时的内容
  content     String   @db.Text
  /// 关联的笔记 ID
  noteId      String
  /// 关联的笔记
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  /// 版本创建时间
  createdAt   DateTime @default(now())

  @@index([noteId, createdAt])
}

/// 每日笔记模型 - 按日期组织的笔记容器
model DailyNote {
  /// 每日笔记唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 日期（唯一）
  date        DateTime @unique @db.Date
  /// 每日笔记内容（Markdown 格式）
  content     String   @db.Text

  /// 创建者用户 ID
  userId      String
  /// 关联的用户
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 关联的笔记列表
  notes       Note[]

  /// 创建时间
  createdAt   DateTime @default(now())
  /// 更新时间
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

// ==================== 博客系统 ====================

/// 文章模型 - 公开发布的博客文章
model Post {
  /// 文章唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 文章标题
  title       String
  /// 文章内容（Markdown 格式）
  content     String   @db.Text
  /// 文章摘要，用于列表和 SEO
  excerpt     String?  @db.Text
  /// URL 友好的唯一标识符
  slug        String   @unique
  /// 封面图片 URL
  coverImage  String?

  /// 是否已发布
  published   Boolean  @default(false)
  /// 发布时间
  publishedAt DateTime?

  /// SEO 元标题
  metaTitle       String? @db.Text
  /// SEO 元描述
  metaDescription String? @db.Text

  /// 浏览次数
  views       Int      @default(0)
  /// 点赞数
  likes       Int      @default(0)

  /// 作者用户 ID
  userId      String
  /// 关联的用户
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 关联的笔记 ID（如果文章由笔记发布）
  noteId      String?  @unique
  /// 关联的笔记
  note        Note?    @relation("NotePost", fields: [noteId], references: [id])

  /// 所属分类 ID
  categoryId  String?
  /// 关联的分类
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  /// 关联的标签
  tags        Tag[]
  /// 文章的评论
  comments    Comment[]

  /// 创建时间
  createdAt   DateTime @default(now())
  /// 更新时间
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([published, publishedAt])
  @@index([slug])
  // 注意：PostgreSQL 全文搜索可以通过原生 SQL 实现，Prisma 的 @@fulltext 支持有限
  // 如需全文搜索，可以在应用层使用 PostgreSQL 的 to_tsvector 和 to_tsquery
}

/// 评论模型 - 文章评论，支持嵌套回复
model Comment {
  /// 评论唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 评论内容
  content     String   @db.Text
  /// 评论作者名称
  authorName  String
  /// 评论作者邮箱
  authorEmail String?
  /// 评论作者网站 URL
  authorUrl   String?

  /// 关联的文章 ID
  postId      String
  /// 关联的文章
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  /// 父评论 ID（用于嵌套回复）
  parentId    String?
  /// 父评论
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  /// 子评论（回复）
  replies     Comment[] @relation("CommentReplies")

  /// 关联的用户 ID（如果评论者是登录用户）
  userId      String?
  /// 关联的用户
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// 是否已审核通过
  approved    Boolean  @default(false)

  /// 创建时间
  createdAt   DateTime @default(now())
  /// 更新时间
  updatedAt   DateTime @updatedAt

  @@index([postId])
  @@index([parentId])
  @@index([approved, createdAt])
}

// ==================== 分类和标签 ====================

/// 分类模型 - 笔记和文章的分类组织
model Category {
  /// 分类唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 分类名称
  name        String
  /// URL 友好的唯一标识符
  slug        String   @unique
  /// 分类描述
  description String?  @db.Text
  /// 分类颜色标识（十六进制颜色值，如 #FF5733）
  color       String?

  /// 关联的笔记
  notes       Note[]
  /// 关联的文章
  posts       Post[]

  /// 创建时间
  createdAt   DateTime @default(now())
  /// 更新时间
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

/// 标签模型 - 笔记和文章的标签标记
model Tag {
  /// 标签唯一标识符（UUID）
  id          String   @id @default(uuid())
  /// 标签名称，唯一
  name        String   @unique
  /// URL 友好的唯一标识符
  slug        String   @unique
  /// 标签颜色标识（十六进制颜色值，如 #FF5733）
  color       String?

  /// 关联的笔记
  notes       Note[]
  /// 关联的文章
  posts       Post[]

  /// 创建时间
  createdAt   DateTime @default(now())

  @@index([slug])
}

